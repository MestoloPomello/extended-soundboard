<!-- Login Page -->
<div id="login-page" class="login-container">
	<div class="login-card">
		<div class="login-header">
			<i class="fas fa-lock"></i>
			<h1>Pannello Amministrazione</h1>
			<p>Inserisci la password per accedere</p>
		</div>
		<form class="login-form" onsubmit="handleLogin(event)">
			<div class="error-message" id="error-message">
				<i class="fas fa-exclamation-circle"></i>
				<span>Password errata. Riprova.</span>
			</div>
			<div class="form-group">
				<label for="password">Password</label>
				<input 
					type="password" 
					id="password" 
					name="password" 
					placeholder="Inserisci la password"
					autocomplete="off"
					required
				/>
			</div>
			<button type="submit" class="btn-login">
				Accedi
			</button>
		</form>
	</div>
</div>

<!-- Admin Panel -->
<div id="admin-panel" style="display: none;">
	<div class="admin-container">
		<div class="admin-header">
			<h1><i class="fas fa-database"></i> Gestione Audio</h1>
			<div class="header-actions">
				<a href="/?guildId={{guildId}}" class="btn-back">
					<i class="fas fa-arrow-left"></i> Soundboard
				</a>
				<button class="btn-logout" onclick="handleLogout()">
					<i class="fas fa-sign-out-alt"></i> Esci
				</button>
			</div>
		</div>

		<div class="admin-controls">
			<div class="search-box">
				<i class="fas fa-search"></i>
				<input type="text" id="admin-search" placeholder="Cerca per nome o autore..." />
			</div>
			<div class="info-box">
				<span id="total-count">Caricamento...</span>
			</div>
		</div>

		<div id="loading" class="loading-overlay">
			<div class="spinner"></div>
			<p>Operazione in corso...</p>
		</div>

		<div class="table-container">
			<table class="admin-table">
				<thead>
					<tr>
						<th>Nome File</th>
						<th>Autori</th>
						<th>Dimensione</th>
						<th>Data</th>
						<th>Azioni</th>
					</tr>
				</thead>
				<tbody id="files-tbody">
					<tr>
						<td colspan="5" class="empty-state">
							<i class="fas fa-spinner fa-spin"></i>
							<p>Caricamento dei file...</p>
						</td>
					</tr>
				</tbody>
			</table>
		</div>

		<div class="pagination-container">
			<button id="prev-page" class="btn-pagination" disabled>
				<i class="fas fa-chevron-left"></i> Precedente
			</button>
			<span id="page-info">Pagina 1 di 1</span>
			<button id="next-page" class="btn-pagination" disabled>
				Successivo <i class="fas fa-chevron-right"></i>
			</button>
		</div>
	</div>
</div>

<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script>
	// ===== Authentication =====
	async function checkAuth() {
		try {
			const response = await fetch('/admin/check-auth');
			const data = await response.json();
			
			if (data.isAuthenticated) {
				showAdminPanel();
			}
		} catch (error) {
			console.error('Error checking auth:', error);
		}
	}

	async function handleLogin(event) {
		event.preventDefault();
		const password = document.getElementById('password').value;
		const errorMsg = document.getElementById('error-message');

		try {
			const response = await fetch('/admin/login', {
				method: 'POST',
				headers: {
					'Content-Type': 'application/json'
				},
				body: JSON.stringify({ password })
			});

			if (response.ok) {
				errorMsg.classList.remove('show');
				showAdminPanel();
			} else {
				errorMsg.classList.add('show');
				document.getElementById('password').value = '';
				document.getElementById('password').focus();
			}
		} catch (error) {
			console.error('Login error:', error);
			showError('Errore durante il login');
		}
	}

	async function handleLogout() {
		if (!confirm('Sei sicuro di voler uscire?')) return;

		try {
			await fetch('/admin/logout', {
				method: 'POST'
			});
			location.reload();
		} catch (error) {
			console.error('Logout error:', error);
			location.reload();
		}
	}

	function showAdminPanel() {
		document.getElementById('login-page').style.display = 'none';
		document.getElementById('admin-panel').style.display = 'block';
		loadFiles(1, "");
	}

	// ===== File Management =====
	let currentPage = 1;
	let currentSearch = "";
	let totalPages = 1;
	let isLoading = false;

	async function loadFiles(page = 1, search = "") {
		if (isLoading) return;
		isLoading = true;
		$("#loading").addClass('show');

		try {
			const response = await fetch(`/admin/files?page=${page}&pageSize=50&search=${encodeURIComponent(search)}`);
			
			if (!response.ok) {
				if (response.status === 401) {
					location.reload();
					return;
				}
				throw new Error("Errore nel caricamento dei file");
			}

			const data = await response.json();
			currentPage = data.page;
			totalPages = data.totalPages;

			renderTable(data.files);
			updatePagination(data);
			updateTotalCount(data.total);
		} catch (error) {
			console.error("Error loading files:", error);
			showError("Errore nel caricamento dei file");
		} finally {
			isLoading = false;
			$("#loading").removeClass('show');
		}
	}

	function renderTable(files) {
		const tbody = $("#files-tbody");
		tbody.empty();

		if (files.length === 0) {
			tbody.append(`
				<tr>
					<td colspan="5">
						<div class="empty-state">
							<i class="fas fa-folder-open"></i>
							<p>Nessun file trovato</p>
						</div>
					</td>
				</tr>
			`);
			return;
		}

		files.forEach(file => {
			const authorsText = file.authors ? file.authors.join(", ") : "N/A";
			const date = new Date(file.birthtime).toLocaleDateString("it-IT", {
				year: 'numeric',
				month: 'short',
				day: 'numeric'
			});
			
			const row = $(`
				<tr>
					<td>
						<div class="file-name">
							<i class="fas fa-file-audio"></i>
							<span>${escapeHtml(file.displayName)}</span>
						</div>
					</td>
					<td class="authors-cell">${escapeHtml(authorsText)}</td>
					<td class="size-cell">${file.formattedSize}</td>
					<td class="date-cell">${date}</td>
					<td>
						<div class="actions">
							<button 
								class="btn-action btn-refresh" 
								onclick="refreshFile('${escapeHtml(file.name)}')" 
								title="Aggiorna da MEGA"
							>
								<i class="fas fa-sync-alt"></i>
							</button>
							<button 
								class="btn-action btn-delete" 
								onclick="deleteFile('${escapeHtml(file.name)}')" 
								title="Elimina locale"
							>
								<i class="fas fa-trash"></i>
							</button>
						</div>
					</td>
				</tr>
			`);
			tbody.append(row);
		});
	}

	function updatePagination(data) {
		$("#page-info").text(`Pagina ${data.page} di ${data.totalPages}`);
		$("#prev-page").prop("disabled", data.page <= 1);
		$("#next-page").prop("disabled", data.page >= data.totalPages);
	}

	function updateTotalCount(total) {
		$("#total-count").text(`${total} file totali`);
	}

	async function refreshFile(fileName) {
		if (!confirm(`Aggiornare "${fileName}" da MEGA?\n\nIl file locale verrà eliminato e riscaricato.`)) {
			return;
		}

		$("#loading").addClass('show');
		try {
			const response = await fetch(`/admin/refresh`, {
				method: "POST",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ fileName })
			});

			const result = await response.json();
			
			if (!response.ok) {
				if (response.status === 401) {
					location.reload();
					return;
				}
				throw new Error(result.error || "Errore durante l'aggiornamento");
			}

			await loadFiles(currentPage, currentSearch);
		} catch (error) {
			console.error("Error refreshing file:", error);
			showError("Errore: " + error.message);
		} finally {
			$("#loading").removeClass('show');
		}
	}

	async function deleteFile(fileName) {
		if (!confirm(`Eliminare "${fileName}"?\n\nIl file rimarrà su MEGA ma verrà eliminato localmente.`)) {
			return;
		}

		$("#loading").addClass('show');
		try {
			const response = await fetch(`/admin/delete`, {
				method: "DELETE",
				headers: { "Content-Type": "application/json" },
				body: JSON.stringify({ fileName })
			});

			const result = await response.json();
			
			if (!response.ok) {
				if (response.status === 401) {
					location.reload();
					return;
				}
				throw new Error(result.error || "Errore durante l'eliminazione");
			}

			await loadFiles(currentPage, currentSearch);
		} catch (error) {
			console.error("Error deleting file:", error);
			showError("Errore: " + error.message);
		} finally {
			$("#loading").removeClass('show');
		}
	}

	function showError(message) {
		alert(message);
	}

	function escapeHtml(text) {
		const map = {
			'&': '&amp;',
			'<': '&lt;',
			'>': '&gt;',
			'"': '&quot;',
			"'": '&#039;'
		};
		return text.replace(/[&<>"']/g, m => map[m]);
	}

	// ===== Event Listeners =====
	let searchTimeout;
	$("#admin-search").on("input", function() {
		clearTimeout(searchTimeout);
		searchTimeout = setTimeout(() => {
			currentSearch = $(this).val();
			loadFiles(1, currentSearch);
		}, 500);
	});

	$("#prev-page").on("click", () => {
		if (currentPage > 1) {
			loadFiles(currentPage - 1, currentSearch);
		}
	});

	$("#next-page").on("click", () => {
		if (currentPage < totalPages) {
			loadFiles(currentPage + 1, currentSearch);
		}
	});

	// ===== Initialize =====
	$(document).ready(() => {
		checkAuth();
	});
</script>